<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Richards Growth Model Estimation</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f4f4f4;
            margin: 0;
            padding: 20px;
        }
        h1, h2 {
            text-align: center;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: #fff;
            padding: 20px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            border-radius: 8px;
        }
        .table-container {
            overflow-x: auto;
            margin-bottom: 20px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
        }
        th, td {
            border: 1px solid #ccc;
            padding: 8px;
            text-align: center;
            word-wrap: break-word;
        }
        th {
            background-color: #f8f8f8;
        }
        button {
            background-color: #007bff;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        button:hover {
            background-color: #0056b3;
        }
        canvas {
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <h1>Richards Growth Model Estimation</h1>
    <div class="container">
        <h2>Input Data</h2>
        <button onclick="addDay()">Add Day</button><br><br>
        <div class="table-container">
            <table id="dataTable">
                <thead>
                    <tr>
                        <th>Day</th>
                        <th>Size</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
        <button onclick="processData()">Estimate Growth Model</button>
        <h2>Results</h2>
        <div id="results"></div>
        <h2>Visualization</h2>
        <canvas id="chart"></canvas>
    </div>
    <script>
        let dayCount = 0;
        let chartInstance = null;

        function addDay() {
            const tableBody = document.querySelector("#dataTable tbody");
            const row = document.createElement("tr");
            row.innerHTML = `
                <td><input type="number" value="${dayCount++}" readonly></td>
                <td><input type="number" min="0" step="0.01" placeholder="Enter size"></td>
            `;
            tableBody.appendChild(row);
        }

        function richardsModel(t, params) {
            const [L, K, m, W0] = params;
            return L / (1 + Math.exp(-K * (t - m))) + W0;
        }

        function levenbergMarquardtFit(t, y) {
            const params = [Math.max(...y), 1, t.reduce((a, b) => a + b, 0) / t.length, y[0]]; // [L, K, m, W0]
            const maxIterations = 200;
            const tolerance = 1e-6;

            let residuals = (params) => {
                return t.map((ti, i) => y[i] - richardsModel(ti, params));
            };

            let loss = (params) => {
                const res = residuals(params);
                return res.reduce((sum, r) => sum + r ** 2, 0);
            };

            const gradientStep = 1e-6;

            for (let iter = 0; iter < maxIterations; iter++) {
                const currentLoss = loss(params);
                const gradients = params.map((_, idx) => {
                    const paramsUp = [...params];
                    const paramsDown = [...params];
                    paramsUp[idx] += gradientStep;
                    paramsDown[idx] -= gradientStep;
                    return (loss(paramsUp) - loss(paramsDown)) / (2 * gradientStep);
                });

                // Update parameters using a simple gradient-based step
                for (let idx = 0; idx < params.length; idx++) {
                    params[idx] -= 0.01 * gradients[idx];
                }

                // Convergence check
                if (Math.abs(currentLoss - loss(params)) < tolerance) break;
            }

            return params;
        }

        function processData() {
            const rows = document.querySelectorAll("#dataTable tbody tr");
            const days = [];
            const sizes = [];

            rows.forEach((row) => {
                const day = parseFloat(row.children[0].querySelector("input").value);
                const size = parseFloat(row.children[1].querySelector("input").value);
                if (!isNaN(day) && !isNaN(size)) {
                    days.push(day);
                    sizes.push(size);
                }
            });

            if (days.length === 0 || sizes.length === 0) {
                alert("Please enter valid data for at least one day.");
                return;
            }

            // Optimize parameters using custom Levenberg-Marquardt
            const params = levenbergMarquardtFit(days, sizes);

            const tPred = Array.from({ length: Math.max(...days) + 1 }, (_, i) => i);
            const yPred = tPred.map((t) => richardsModel(t, params));

            const [L, K, m, W0] = params;

            document.getElementById("results").innerHTML = `
                <p><strong>Estimated Parameters:</strong></p>
                <p>L (Carrying Capacity): ${L.toFixed(4)}</p>
                <p>K (Growth Rate): ${K.toFixed(4)}</p>
                <p>m (Inflection Point): ${m.toFixed(4)}</p>
                <p>W0 (Initial Size): ${W0.toFixed(4)}</p>
            `;

            if (chartInstance) chartInstance.destroy();

            const ctx = document.getElementById("chart").getContext("2d");
            chartInstance = new Chart(ctx, {
                type: "line",
                data: {
                    labels: tPred,
                    datasets: [
                        {
                            label: "Model Prediction",
                            data: yPred,
                            borderColor: "red",
                            fill: false,
                            tension: 0.1,
                        },
                        {
                            label: "Observed Data",
                            data: sizes,
                            borderColor: "blue",
                            backgroundColor: "blue",
                            fill: false,
                            tension: 0.1,
                            pointStyle: "circle",
                            pointRadius: 5,
                            showLine: false,
                        },
                    ],
                },
                options: {
                    responsive: true,
                    scales: {
                        x: { title: { display: true, text: "Days" }, min: 0 },
                        y: { title: { display: true, text: "Size" } },
                    },
                },
            });
        }
    </script>
</body>
</html>
